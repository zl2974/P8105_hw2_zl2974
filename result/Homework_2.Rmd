---
title: "Homework 2"
author: "Jeffrey Liang"
date: "9/23/2020"
output: 
 github_document
---
```{r setup ,echo = F, message= F}
library(tidyverse)
```

# Problem 1 

## Load Wheel data
```{r load_whell_data, warning=F, message=FALSE}
data_collection = c() #Load the wheel data
for (i in c(1:3)){
  data_collection[[i]] = 
    readxl::read_excel(
      paste(here::here(),"/data/Trash-Wheel-Collection-Totals-8-6-19.xlsx",sep=''),
      skip = 1, 
      sheet = i
    ) %>% 
    janitor::clean_names() %>% 
    select( -starts_with('X1'))
}

wheel_df = bind_rows(data_collection)

preci_collection = c() # load the precipitation data in wheel
for (i in c(4:9)){
  preci_collection[[i]] = 
    readxl::read_excel(
      paste(here::here(),"/data/Trash-Wheel-Collection-Totals-8-6-19.xlsx",sep=''),
      skip = 1,
      sheet = i
    ) %>% 
    janitor::clean_names() %>% 
    mutate(year = 2020 + 3 -i)
}

preci_df = bind_rows(preci_collection)

rm(data_collection,preci_collection)
```


## Clean Wheel data

```{r clean_data}
wheel_df = #clean wheel
  wheel_df %>% 
  filter(
    #!grep(" Total",get('month')), #this command return vector with null row, so the data can't subset
    !str_detect(get("month")," Total"),
    !is.na(get("dumpster")) #Or drop_na(dumpster)
    ) %>% 
  mutate(sports_balls = 
           as.integer(round(get("sports_balls")))
         )
tail(wheel_df)
```

## Clean precipitation data
```{r}
preci_df = 
  preci_df %>%
  filter(!is.na(get("month")),
         get('year') %in% c(2018,2017)
         ) %>% 
  mutate(month =
           apply( # this is the apply() function in R, need to specific dim before giving function, weird
             as.matrix(           # as.matrix is very important here, cuz pull() or get() have NULL dim()
             get("month")
             ), 1, # specific dim()
             function(x) month.name[[x]]) # this is how to write lambda in R, clean
  ) %>%  # OR use month = month.names[month], or create a tabel with order and then left join
  relocate(year)
tail(preci_df)
```


## Write something about this data
 
\newpage
# Problem 2

## load data
```{r load_nyc,message=F,warning=F}
rm(list=ls())
read_nyc = function(){
return_data = read_csv(
  paste(here::here(),"/data/NYC_Transit_Subway_Entrance_And_Exit_Data.csv",sep = '')
) %>% 
  janitor::clean_names()
return(return_data)
}
#skimr::skim_without_charts(nyc_df) # TODO: route* need to be in the same columns
```

## Clean data
```{r how_to_do_for_loop_mutation, include=FALSE,echo = FALSE}
nyc_df = read_nyc()
for (i in 1:11){
  col_name = paste("route",i,sep='')
  mutate(nyc_df,!!as.symbol(col_name) := as.character(pull(nyc_df,as.name(col_name))))
  #use !! before variable to avoid evaluation, use := for dynamic name assigning
  # I have to say, dplyr is readable, but pain in the ass from a computing perspective,
  # one thing for sure that it would be great amount of work transferring dplyr script to other language
}
```

```{r clean_nyc_data,warning=F,message=F}
nyc_df = 
  read_nyc() %>% 
  select(line:station_longitude,route1:route11,vending,entry,entrance_type,ada) %>% 
  mutate(entry = if_else(
    apply(as.matrix(entry),1,str_to_lower)=="yes",
    TRUE,FALSE,NA),
    vending = if_else(vending=="YES",T,F,NA)
    )

nyc_df_tidy = nyc_df %>% 
  mutate(across(matches('route'),as.character)) %>% #OR use across(matches("something",fun))
  relocate(route1:route11,.after = last_col()) %>% 
  pivot_longer( # clean route* variables to meaningful route variable
    cols = route1:route11, #route 8 is numeric
    names_to = "route",
    values_to = 'route_value',
    names_prefix = 'route'
  ) %>% 
  drop_na(route_value) %>%
  mutate(
    route_number = if_else(route_value %in% as.character(c(1:12)),route_value, ''),
    route_name = if_else(route_number=='',route_value,''),
    ) %>% 
  select(-c(route_value,route))
tail(nyc_df)
```
This NYC's metro system data is a `r nrow(read_nyc())` x `r ncol(read_nyc())` size data, describing NYC metro system's **_`r paste(names(read_nyc()),sep = ',')`_**.

The data is not beautiful in all sense: 

1. It has route all over the place and name and line separated instead of treating as unique indentity;
1. value types in route* were not consistent;
1. Boolean variable in _vending_ and _entry_ were in form of "YES"/"NO" instead of boolean.

So the first step I did to the data was to select required variables. Followed with changing values in _entrance_ variable to boolean factors with if_else() function. Then I took the information in the route\*: first dealed with route 8 to 11 which not consistent with the other line format of data and put them into _route_ and *route_value* variables using pivot_longer(). To seperate 

The outcome data after piping is a dataset of `r nrow(nyc_df)` x `r ncol(nyc_df)` size dataset, with variables of **_`r names(nyc_df)`_**, and the data with following properties:

* there's `r count(distinct(nyc_df,station_name,line))` unique station (including names and line) in this data;
* Of `r nrow(nyc_df)`, `r sum(pull(nyc_df,'ada'))` are ADA compliant stations;
* Of `r nrow(nyc_df)`, `r 1- round(sum(pull(nyc_df,vending))/nrow(nyc_df),2)` station entrance/exits without vending allow entrance.

After transforming the NYC transit data, of `r count(distinct(nyc_df_tidy,station_name,line))` stations, 
`r nyc_df_tidy %>% distinct(station_name,line,.keep_all=TRUE) %>% filter(route_name=="A") %>% count()` serve route A.

\newpage
# Problem 3
## Load data
```{r load_five, message=F,warning=F}
rm(list=ls())
read_five = function(data_name_index = 1){
  data_name = str_c(c("pols-month",'unemployment',"snp"),".csv")
  read_data = 
    read_csv(paste(here::here(),"/data/fivethirtyeight_datasets/",data_name[[data_name_index]],sep=''),
             ) %>% 
    janitor::clean_names()
}

#load month data
pols_month = read_five(1) %>% 
  separate(mon,c("year","month",'day'),"-") %>% 
  mutate(across(.cols = year:day,as.integer)) %>% 
  left_join(tibble(month = 1:12,month_name = month.name)) %>% 
  mutate(month = month_name) %>% 
  select(-month_name) %>% 
  pivot_longer( # OR mutate president = 
    c("prez_gop","prez_dem"),
    names_to = "president",
    values_to = "president_boolean",
    names_prefix="prez_"
  ) %>% 
  filter(president_boolean == 1) %>% 
  select(-c(president_boolean,day)) %>% 
  mutate(president = factor(president,levels = c('dem',"gop")))
str(pols_month)

#load and clean snp data
snp_data = read_five(3) %>% 
  separate(col = date,into = c("month","day","year"),"/") %>% 
  select(-day) %>% 
  mutate(across(.cols = year:month,as.numeric),
         month = month.name[month]
         ) %>% 
  relocate(year,month)
str(snp_data)

#load unemployment data
unemploy_data = read_five(2) %>% 
  pivot_longer(
    jan:dec,
    names_to = "month",
    values_to="unemploy_rate"
  ) %>% 
  mutate(month = apply(as.matrix(month),1,
                       function(x) month.name[[
                         match(x,str_to_lower(month.abb))
                         ]]))
str(unemploy_data)
```
## Join data
```{r}
five30eight = pols_month %>% 
  left_join(snp_data, by = c("year","month")) %>% 
  left_join(unemploy_data, by = c("year","month"))
skimr::skim_without_charts(five30eight)
```

